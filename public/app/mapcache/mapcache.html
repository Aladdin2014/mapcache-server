<div class="mapcache container-fluid">

  <div class="container">
    <div class="row top-gap-l bottom-gap">
      <div class="col-md-12">
        <div class="mapcache-header-description">Use mapcache to save maps for offline use in mobile applications. <button class="btn btn-default" ng-click="createCache()">Create Cache</button></div>
      </div>
    </div>
  </div>

  <div class="row top-gap bottom-gap">
    <div class="col-md-12">
      <div leaflet></div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="form-group">
          <label>Filter Caches</label>
          <input class="form-control" ng-model="cacheFilter" placeholder="Please enter at least two letters to filter caches">
        </div>
      </div>
    </div>

    <div class="cache-row bottom-gap-l" ng-repeat="cache in caches | filter:cacheFilter | filter: mapFilter" ng-mouseenter="mouseOver(cache)" ng-mouseleave="mouseOut(cache)">
      <div class="row">
        <div class="col-md-12">
          <div class="cache-name"><a href="/#/cache/{{cache.id}}">{{cache.name}}</a> <span ng-if="!cache.status.complete">Currently Generating</span>
            <button class="btn btn-link btn-sm" ng-click="cache.showingDetails = !cache.showingDetails"><span ng-show="cache.showingDetails">hide cache details</span><span ng-show="!cache.showingDetails">view cache details</span></button>
            <button class="btn btn-link btn-sm" ng-click="toggleCacheTiles(cache)"><span ng-show="cache.showingTiles">hide cache</span><span ng-show="!cache.showingTiles">show cache on map</span></button>
          </div>
        </div>
      </div>
      <div class="row top-gap-s" ng-show="cache.showingDetails && cache.status.complete">
        <div class="col-md-12">
          <dl class="dl-horizontal">
            <dt>Zoom Levels</dt>
            <dd>{{cache.minZoom}} - {{cache.maxZoom}}</dd>
            <dt>Cache URL</dt>
            <dd>/api/caches{{cache.url}}/{z}/{x}/{y}.png</dd>
            <dt>Total Tiles</dt>
            <dd>{{cache.status.generatedTiles}}</dd>
            <dt>Bounding Box</dt>
            <dd>{{cacheBoundingBox(cache)}}</dd>
            <dt>Source</dt>
            <dd><a href="/#/source/{{cache.source.id}}">{{cache.source.name}}</a></dd>
            <dt ng-if="cache.source.url">Source URL</dt>
            <dd ng-if="cache.source.url">{{cache.source.url}}/{z}/{x}/{y}.png</dd>
            <!--<dt>Download Missing Tiles</dt>
            <dd><a ng-click="downloadMissingTiles(cache)">download missing tiles</a></dd>-->
          </dl>
        </div>
      </div>
      <div class="row" ng-show="cache.status.complete">
        <div class="col-md-12">
          <a target="_blank" ng-href="/api/caches/{{cache.id}}.zip?minZoom=0&maxZoom=18&format=xyz&access_token={{token}}">
            <div class="col-md-2 cache-type-details">
              <div class="cache-type"><i class="fa fa-download"></i> XYZ</div>
              <div class="cache-size">{{cache.totalTileSize | fileSize}}</div>
            </div>
          </a>
          <a class="cache-type-download-box" target="_blank" ng-href="/api/caches/{{cache.id}}.zip?minZoom=0&maxZoom=18&format=tms&access_token={{token}}">
            <div class="col-md-2 cache-type-details">
              <div class="cache-type"><i class="fa fa-download"></i> TMS</div>
              <div class="cache-size">{{cache.totalTileSize | fileSize}}</div>
            </div>
          </a>
            <div class="col-md-2 cache-type-details">
              <a class="cache-type-download-box" target="_blank" ng-href="/api/caches/{{cache.id}}.zip?minZoom=0&maxZoom=18&format=geopackage&access_token={{token}}">
                <div ng-show="cacheFormatExists(cache, 'geopackage')">
                  <div class="cache-type"><i class="fa fa-download"></i> GeoPackage</div>
                  <div class="cache-size">{{cache.formats['geopackage'].size | fileSize}}</div>
                </div>
              </a>
              <div ng-show="cacheFormatGenerating(cache, 'geopackage')">
                <div class="cache-type"><i class="fa fa-spinner fa-pulse"></i> GeoPackage</div>
                <div class="cache-size">Generating...</div>
              </div>
              <a class="cache-type-download-box" ng-click="generateFormat(cache, 'geopackage')" ng-href="">
                <div ng-hide="cacheFormatExists(cache, 'geopackage') || cacheFormatGenerating(cache, 'geopackage')">
                  <div class="cache-type">GeoPackage</div>
                  <div class="cache-size">Click to Generate</div>
                </div>
              </a>
            </div>
          </a>
            <div class="col-md-2 cache-type-details">
              <a class="cache-type-download-box" target="_blank" ng-href="/api/caches/{{cache.id}}.zip?minZoom=0&maxZoom=18&format=mbtiles&access_token={{token}}">
                <div ng-show="cacheFormatExists(cache, 'mbtiles')">
                  <div class="cache-type"><i class="fa fa-download"></i> MBTiles</div>
                  <div class="cache-size">{{cache.formats['mbtiles'].size | fileSize}}</div>
                </div>
              </a>
              <div ng-show="cacheFormatGenerating(cache, 'mbtiles')">
                <div class="cache-type"><i class="fa fa-spinner fa-pulse"></i> MBTiles</div>
                <div class="cache-size">Generating...</div>
              </div>
              <a class="cache-type-download-box" ng-click="generateFormat(cache, 'mbtiles') || cacheFormatGenerating(cache, 'mbtiles')" ng-href="">
                <div ng-hide="cacheFormatExists(cache, 'mbtiles') || cacheFormatGenerating(cache, 'mbtiles')">
                  <div class="cache-type">MBTiles</div>
                  <div class="cache-size">Click to Generate</div>
                </div>
              </a>
            </div>
          </a>
        </div>
      </div>
      <div class="row" ng-show="!cache.status.complete">
        <div class="col-md-12">
          <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: {{cacheProgress(cache)}}%">
              <span>{{cacheProgress(cache) | number: 2}}% Complete</span>
            </div>
          </div>
        </div>
      </div>
      <div class="row cache-types-row" ng-show="!cache.status.complete && cache.showingDetails">
        <div class="col-md-12" ng-init="zoomRows = sortedZooms(cache)">
          <div class="row" ng-repeat="zoomRow in zoomRows">
            <div class="col-md-4" ng-repeat="zoom in zoomRow">
              Zoom Level {{zoom.zoom}} {{zoom.status.size | fileSize}}
              <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: {{zoomProgress(zoom.status)}}%">
                  <span>{{zoomProgress(zoom.status) | number: 2}}% Complete</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
